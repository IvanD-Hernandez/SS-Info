DO $$
DECLARE
  v_user text := '${POSTGRES_USER}';
  v_pass text := '${POSTGRES_PASSWORD}';
BEGIN
  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = v_user) THEN
    EXECUTE format('CREATE USER %I WITH PASSWORD %L', v_user, v_pass);
  END IF;
END$$;

DO $$
DECLARE
  v_db   text := '${POSTGRES_DB}';
  v_user text := '${POSTGRES_USER}';
BEGIN
  IF NOT EXISTS (SELECT FROM pg_database WHERE datname = v_db) THEN
    EXECUTE format('CREATE DATABASE %I OWNER %I', v_db, v_user);
  END IF;
  EXECUTE format('ALTER DATABASE %I OWNER TO %I', v_db, v_user);
END$$;

\connect ${POSTGRES_DB}

ALTER SCHEMA public OWNER TO ${POSTGRES_USER};
GRANT ALL PRIVILEGES ON SCHEMA public TO ${POSTGRES_USER};
GRANT ALL PRIVILEGES ON DATABASE ${POSTGRES_DB} TO ${POSTGRES_USER};

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS pgcrypto;
